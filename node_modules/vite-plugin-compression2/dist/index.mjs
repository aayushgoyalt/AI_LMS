var at=Object.create;var j=Object.defineProperty;var lt=Object.getOwnPropertyDescriptor;var ut=Object.getOwnPropertyNames;var pt=Object.getPrototypeOf,ct=Object.prototype.hasOwnProperty;var mt=(t,e)=>()=>(t&&(e=t(t=0)),e);var V=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports),ft=(t,e)=>{for(var r in e)j(t,r,{get:e[r],enumerable:!0})},q=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of ut(e))!ct.call(t,i)&&i!==r&&j(t,i,{get:()=>e[i],enumerable:!(n=lt(e,i))||n.enumerable});return t};var gt=(t,e,r)=>(r=t!=null?at(pt(t)):{},q(e||!t||!t.__esModule?j(r,"default",{value:t,enumerable:!0}):r,t)),dt=t=>q(j({},"__esModule",{value:!0}),t);var W={};ft(W,{TypedArrayPrototype:()=>wt,defineEsShim:()=>Ct,defineProperties:()=>Y,makeEsShim:()=>Q,uncurryThis:()=>Z});function Q(t,e){Y(t,{implementation:e,getPolyfill:()=>e,shim:()=>e})}function Ct(t,e=!1,r=null){return{implementation:t,polyfill:()=>t,shim:()=>t,auto(){},index(){let n=r||(e?t:Z(t));return Q(n,t),n}}}var Z,wt,At,Y,X=mt(()=>{Z=t=>(e,...r)=>t.call(e,...r),wt=Object.getPrototypeOf(Uint8Array.prototype),At=(t,e,r,n)=>{if(e in t){if(n===!0){if(t[e]===r)return}else if(typeof n!="function"||!n())return}Object.defineProperty(t,e,{configurable:!0,enumerable:!1,value:r,writable:!0})},Y=(t,e,r)=>{let n=Array.prototype.concat.call(Object.keys(e),Object.getOwnPropertySymbols(e));for(let i=0,o=n.length;i<o;i++){let s=n[i];At(t,s,e[s],r==null?void 0:r[s])}}});var J=V((C,$)=>{"use strict";Object.defineProperty(C,"__esModule",{value:!0}),Object.defineProperty(C,"default",{enumerable:!0,get:function(){return vt}});var xt=(X(),dt(W)),Tt=typeof AggregateError=="function"?AggregateError:(()=>{function t(e,r){let n=Error(r);return Object.setPrototypeOf(n,t.prototype),delete n.constructor,Object.defineProperty(n,"errors",{value:Array.from(e)}),n}return Object.defineProperty(t,"prototype",{writable:!1}),Object.defineProperties(t.prototype,{constructor:{enumerable:!1,configurable:!0,writable:!0,value:t},message:{enumerable:!1,configurable:!0,writable:!0,value:""},name:{enumerable:!1,configurable:!0,writable:!0,value:"AggregateError"}}),Object.setPrototypeOf(t.prototype,Error.prototype),t})(),vt=(0,xt.defineEsShim)(Tt,!0);Object.assign(C.default,C);$.exports=C.default});var H=V((Zt,K)=>{"use strict";K.exports=J().index()});import T from"fs/promises";import jt from"fs";import Et from"os";import P from"path";import{createFilter as It}from"@rollup/pluginutils";import B from"fs/promises";import S from"path";function h(t){return t.length}function _(t,e){let r=typeof e=="function"?e(t):e,{dir:n,base:i}=S.parse(t),o=n?n+"/":"";return r.replace(/\[path\]/,o).replace(/\[base\]/,i)}function A(t){return/^\\\\\?\\/.test(t)?t:t.replace(/\\/g,"/")}async function L(t){let e=await Promise.all((await B.readdir(t)).map(i=>S.join(t,i))),r=0,n=[];for(;r!==h(e);){let i=e[r],o=await B.stat(i);if(o.isDirectory()){let s=await B.readdir(i);e.push(...s.map(p=>S.join(i,p)))}o.isFile()&&n.push(i),r++}return n}function E(t){return typeof t=="string"?new TextEncoder().encode(t):t}import O from"zlib";import ht from"util";import yt from"fs";import bt from"fs/promises";import z from"path";import Ot from"tar-stream";import Pt from"gunzip-maybe";function D(t){let e=t in O?t:"gzip";return{algorithm:ht.promisify(O[e])}}async function N(t,e,r){try{return await e(t,r)}catch(n){return Promise.reject(n)}}var M={gzip:{level:O.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[O.constants.BROTLI_PARAM_QUALITY]:O.constants.BROTLI_MAX_QUALITY}},deflate:{level:O.constants.Z_BEST_COMPRESSION},deflateRaw:{level:O.constants.Z_BEST_COMPRESSION}};function G(){let t=Ot.pack(),e={dests:[],root:""};return{add:(s,p)=>{t.entry({name:s},Buffer.from(E(p)))},write:async()=>{t.finalize(),await Promise.all(e.dests.map(async s=>{let p=A(z.resolve(e.root,s+".tar.gz")),a=A(z.dirname(p));e.root!==a&&await bt.mkdir(a,{recursive:!0});let l=yt.createWriteStream(p);t.pipe(Pt()).pipe(l)}))},setOptions:s=>Object.assign(e,s)}}var tt=gt(H());var R=class{constructor(e){this.maxConcurrent=e,this.queue=[],this.errors=[],this.running=0}enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e()}catch(r){this.errors.push(r)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(h(this.errors))throw new tt.default(this.errors,"task failed")}};function F(t){return new R(t)}var et="vite:build-import-analysis",rt="vite-plugin-compression",Bt="copyPublicDir",nt=(()=>{let t=Et.cpus()||{length:1};return t.length===1?10:Math.max(1,t.length-1)})();function it(t){var n;let e=new Set,r=(i,o)=>A(P.resolve(i,o));return(n=t.build.rollupOptions)!=null&&n.output?(Array.isArray(t.build.rollupOptions.output)?t.build.rollupOptions.output:[t.build.rollupOptions.output]).forEach(o=>{typeof o=="object"&&!h(Object.keys(o))||e.add(r(t.root,o.dir||t.build.outDir))}):e.add(r(t.root,t.build.outDir)),e}async function St(t,e){let r=t.generateBundle;if(typeof r=="object"&&r.handler){let n=r.handler;r.handler=async function(...i){await n.apply(this,i),await e.apply(this,i)}}typeof r=="function"&&(t.generateBundle=async function(...n){await r.apply(this,n),await e.apply(this,n)})}async function ot(t,e){let r=Bt in t.build?t.build.copyPublicDir:!0;if(t.publicDir&&r&&jt.existsSync(t.publicDir)){let n=await L(t.publicDir),i=P.join(t.root,P.relative(t.root,t.publicDir));Promise.all(n.map(async o=>{let s=A(P.relative(i,o));await e(s,o)}))}}function re(t={}){let{dest:e}=t,r=[],n=[],i=[],o=process.cwd(),s=G(),p=F(nt);return{name:"vite-plugin-tarball",enforce:"post",async configResolved(a){n.push(...it(a)),o=a.root,i=e?[e]:n,s.setOptions({dests:i,root:o});let l=k.getPluginAPI(a.plugins);if(l&&l.staticOutputs?r.push(...l.staticOutputs):ot(a,async c=>{r.push(c)}),!a.plugins.find(c=>c.name===et))throw new Error("vite-plugin-cp can't be work in versions lower than vite2.0.0")},async writeBundle(a,l){for(let y in l){let c=l[y];s.add(y,c.type==="asset"?c.source:c.code)}},async closeBundle(){for(let a of n)for(let l of r)p.enqueue(async()=>{let y=P.join(a,l),c=await T.readFile(y);s.add(l,c)});await p.wait(),await s.write()}}}function k(t={}){let{include:e=/\.(html|xml|css|json|js|mjs|svg)$/,exclude:r,threshold:n=0,algorithm:i="gzip",filename:o,compressionOptions:s,deleteOriginalAssets:p=!1,skipIfLargerOrEqual:a=!0}=t,l=It(e,r),y=[],c=[],m=Object.create(null);m.algorithm=typeof i=="string"?D(i).algorithm:i,m.options=typeof i=="function"?s:Object.assign(M[i],s),m.filename=o!=null?o:i==="brotliCompress"?"[path][base].br":"[path][base].gz";let v=F(nt),st=async function(f,g){for(let u in g){if(!l(u))continue;let d=g[u],b=E(d.type==="asset"?d.source:d.code),w=h(b);w<n||v.enqueue(async()=>{let x=_(u,m.filename),U=await N(b,m.algorithm,m.options);a&&h(U)>=w||((p||u===x)&&Reflect.deleteProperty(g,u),this.emitFile({type:"asset",fileName:x,source:U}))})}await v.wait().catch(this.error)},I={staticOutputs:new Set};return{name:rt,apply:"build",enforce:"post",api:I,async configResolved(f){c.push(...it(f)),await ot(f,async(u,d)=>{if(!l(d))return;let{size:b}=await T.stat(d);b>n&&y.push(u)});let g=f.plugins.find(u=>u.name===et);if(!g)throw new Error("vite-plugin-compression can't be work in versions lower than vite2.0.0");St(g,st)},async closeBundle(){for(let f of c)for(let g of y)v.enqueue(async()=>{let u=P.join(f,g),d=await T.readFile(u),b=await N(d,m.algorithm,m.options);if(a&&h(b)>=h(d))return;let w=_(g,m.filename);I.staticOutputs.has(w)||I.staticOutputs.add(w);let x=P.join(f,w);p&&x!==u&&await T.rm(u,{recursive:!0,force:!0}),await T.writeFile(x,b)});await v.wait().catch(f=>f)}}}k.getPluginAPI=t=>{var e;return(e=t.find(r=>r.name===rt))==null?void 0:e.api};var ne=k;export{k as compression,ne as default,re as tarball};
